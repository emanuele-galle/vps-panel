'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import {
  Play,
  Square,
  RotateCw,
  Trash2,
  ExternalLink,
  MoreHorizontal,
  Eye,
  HardDrive,
  Loader2,
} from 'lucide-react';
import { Card, CardContent, CardFooter, CardHeader } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { useProjectsStore } from '@/store/projectsStore';
import { Project } from '@/types';
import api from '@/lib/api';
import { getErrorMessage } from '@/lib/errors';
import { logComponentError } from '@/lib/logger';

interface ProjectCardProps {
  project: Project;
}

interface ProjectSize {
  folder: { size: number; sizeFormatted: string };
  containers: { size: number; sizeFormatted: string; count: number };
  databases: { size: number; sizeFormatted: string; count: number };
  total: { size: number; sizeFormatted: string };
}

const TEMPLATE_LABELS: Record<string, string> = {
  WORDPRESS: 'WordPress',
  NODEJS: 'Node.js',
  NEXTJS: 'Next.js',
  REACT: 'React',
  LARAVEL: 'Laravel',
  PYTHON: 'Python',
  STATIC: 'HTML Statico',
};

type StatusVariant = 'default' | 'success' | 'warning' | 'error' | 'info';

function getStatusVariant(status: string): StatusVariant {
  switch (status) {
    case 'ACTIVE':
      return 'success';
    case 'INACTIVE':
      return 'error';
    case 'BUILDING':
      return 'warning';
    case 'ERROR':
      return 'error';
    default:
      return 'default';
  }
}

function getTemplateLabel(template: string): string {
  return TEMPLATE_LABELS[template] || template;
}

export function ProjectCard({ project }: ProjectCardProps) {
  const router = useRouter();
  const { startProject, stopProject, restartProject, deleteProject } =
    useProjectsStore();
  const [isLoading, setIsLoading] = useState(false);
  const [projectSize, setProjectSize] = useState<ProjectSize | null>(null);
  const [loadingSize, setLoadingSize] = useState(true);

  useEffect(() => {
    fetchProjectSize();
  }, [project.id]);

  const fetchProjectSize = async () => {
    try {
      setLoadingSize(true);
      const response = await api.get('/projects/' + project.id + '/size');
      if (response.data.success) {
        setProjectSize(response.data.data);
      }
    } catch (error: unknown) {
      logComponentError(error, 'ProjectCard', 'fetchSize');
    } finally {
      setLoadingSize(false);
    }
  };

  const handleStart = async () => {
    setIsLoading(true);
    try {
      await startProject(project.id);
    } catch (error: unknown) {
      logComponentError(error, 'ProjectCard', 'start');
    } finally {
      setIsLoading(false);
    }
  };

  const handleStop = async () => {
    setIsLoading(true);
    try {
      await stopProject(project.id);
    } catch (error: unknown) {
      logComponentError(error, 'ProjectCard', 'stop');
    } finally {
      setIsLoading(false);
    }
  };

  const handleRestart = async () => {
    setIsLoading(true);
    try {
      await restartProject(project.id);
    } catch (error: unknown) {
      logComponentError(error, 'ProjectCard', 'restart');
    } finally {
      setIsLoading(false);
    }
  };

  const handleDelete = async () => {
    if (
      !confirm(
        'Sei sicuro di voler eliminare "' + project.name + '"? Questa azione non puÃ² essere annullata.'
      )
    ) {
      return;
    }

    setIsLoading(true);
    try {
      await deleteProject(project.id);
    } catch (error: unknown) {
      logComponentError(error, 'ProjectCard', 'delete');
    } finally {
      setIsLoading(false);
    }
  };

  const handleViewDetails = () => {
    router.push('/dashboard/projects/' + project.id);
  };

  const handleOpenPreview = () => {
    if (project.previewUrl) {
      window.open('https://' + project.previewUrl, '_blank');
    }
  };

  const isActive = project.status === 'ACTIVE';
  const statusLabel = isActive ? 'Attivo' : 'Fermo';

  return (
    <Card className="bg-black/40 backdrop-blur-sm border-white/10 hover:border-cyan-500/30 transition-all group">
      <CardHeader className="pb-3">
        <div className="flex items-start justify-between">
          <div className="flex-1 min-w-0">
            <h3 className="text-base sm:text-lg font-semibold text-white truncate group-hover:text-cyan-400 transition-colors">
              {project.name}
            </h3>
            <p className="text-sm text-gray-500 mt-1 truncate">
              {project.slug}
            </p>
          </div>
          <Badge variant={getStatusVariant(project.status)} className="ml-2 flex-shrink-0">
            {project.status}
          </Badge>
        </div>
      </CardHeader>

      <CardContent className="pb-3">
        <div className="space-y-3">
          {project.description && (
            <p className="text-sm text-gray-400 line-clamp-2">
              {project.description}
            </p>
          )}

          <div className="flex flex-wrap gap-2">
            <Badge variant="info" className="bg-cyan-500/20 text-cyan-400 border-cyan-500/30">
              {getTemplateLabel(project.template)}
            </Badge>
            {project.containers && project.containers.length > 0 && (
              <Badge variant="default" className="bg-purple-500/20 text-purple-400 border-purple-500/30">
                {project.containers.length} Container
              </Badge>
            )}
          </div>

          {/* Project Size */}
          <div className="flex items-center gap-2 text-sm text-gray-500">
            <HardDrive className="h-4 w-4 flex-shrink-0" />
            {loadingSize ? (
              <span className="flex items-center gap-1">
                <Loader2 className="h-3 w-3 animate-spin" />
                <span>Calcolo...</span>
              </span>
            ) : projectSize ? (
              <span title={'Cartella: ' + projectSize.folder.sizeFormatted + ', Container: ' + projectSize.containers.sizeFormatted + ', Database: ' + projectSize.databases.sizeFormatted}>
                {projectSize.total.sizeFormatted}
              </span>
            ) : (
              <span>N/A</span>
            )}
          </div>

          {project.previewUrl && (
            <div className="flex items-center gap-2 text-sm min-w-0">
              <ExternalLink className="h-4 w-4 text-gray-500 flex-shrink-0" />
              <a
                href={'https://' + project.previewUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="text-cyan-400 hover:text-cyan-300 hover:underline truncate transition-colors"
              >
                {project.previewUrl}
              </a>
            </div>
          )}

          <div className="text-xs text-gray-500">
            Creato:{' '}
            {new Date(project.createdAt).toLocaleDateString('it-IT', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            })}
          </div>
        </div>
      </CardContent>

      <CardFooter className="pt-3 border-t border-white/5">
        {/* Mobile: Dropdown Menu */}
        <div className="flex sm:hidden items-center justify-between w-full">
          <div className="flex items-center gap-2">
            <Badge variant={getStatusVariant(project.status)} className="text-xs">
              {statusLabel}
            </Badge>
          </div>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" size="sm" className="h-9 w-9 p-0 border-white/10 bg-black/40 hover:bg-white/5">
                <MoreHorizontal className="h-4 w-4" />
                <span className="sr-only">Azioni</span>
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-48 bg-gray-900 border-white/10">
              <DropdownMenuItem onClick={handleViewDetails} className="text-gray-300 hover:text-white focus:text-white focus:bg-white/5">
                <Eye className="h-4 w-4 mr-2" />
                Dettagli
              </DropdownMenuItem>
              {project.previewUrl && isActive && (
                <DropdownMenuItem onClick={handleOpenPreview} className="text-gray-300 hover:text-white focus:text-white focus:bg-white/5">
                  <ExternalLink className="h-4 w-4 mr-2" />
                  Apri sito
                </DropdownMenuItem>
              )}
              <DropdownMenuSeparator className="bg-white/10" />
              {isActive ? (
                <>
                  <DropdownMenuItem onClick={handleStop} disabled={isLoading} className="text-gray-300 hover:text-white focus:text-white focus:bg-white/5">
                    <Square className="h-4 w-4 mr-2" />
                    Ferma
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={handleRestart} disabled={isLoading} className="text-gray-300 hover:text-white focus:text-white focus:bg-white/5">
                    <RotateCw className="h-4 w-4 mr-2" />
                    Riavvia
                  </DropdownMenuItem>
                </>
              ) : (
                <DropdownMenuItem onClick={handleStart} disabled={isLoading} className="text-gray-300 hover:text-white focus:text-white focus:bg-white/5">
                  <Play className="h-4 w-4 mr-2" />
                  Avvia
                </DropdownMenuItem>
              )}
              <DropdownMenuSeparator className="bg-white/10" />
              <DropdownMenuItem
                onClick={handleDelete}
                disabled={isLoading}
                className="text-red-400 focus:text-red-400 focus:bg-red-500/10"
              >
                <Trash2 className="h-4 w-4 mr-2" />
                Elimina
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>

        {/* Desktop: Button Row */}
        <div className="hidden sm:flex items-center justify-between w-full gap-2">
          <div className="flex items-center gap-1">
            {isActive ? (
              <>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleStop}
                  disabled={isLoading}
                  className="h-8 border-white/10 bg-black/40 text-gray-300 hover:text-white hover:bg-white/5 hover:border-orange-500/30"
                >
                  <Square className="h-3.5 w-3.5 mr-1" />
                  Ferma
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleRestart}
                  disabled={isLoading}
                  className="h-8 border-white/10 bg-black/40 text-gray-300 hover:text-white hover:bg-white/5 hover:border-yellow-500/30"
                >
                  <RotateCw className="h-3.5 w-3.5 mr-1" />
                  Riavvia
                </Button>
              </>
            ) : (
              <Button
                variant="outline"
                size="sm"
                onClick={handleStart}
                disabled={isLoading}
                className="h-8 border-white/10 bg-black/40 text-gray-300 hover:text-white hover:bg-white/5 hover:border-green-500/30"
              >
                <Play className="h-3.5 w-3.5 mr-1" />
                Avvia
              </Button>
            )}

            {project.previewUrl && isActive && (
              <Button
                variant="outline"
                size="sm"
                onClick={handleOpenPreview}
                className="h-8 border-white/10 bg-black/40 text-gray-300 hover:text-cyan-400 hover:bg-cyan-500/5 hover:border-cyan-500/30"
              >
                <ExternalLink className="h-3.5 w-3.5" />
              </Button>
            )}
          </div>

          <div className="flex items-center gap-1">
            <Button
              variant="outline"
              size="sm"
              onClick={handleViewDetails}
              className="h-8 border-white/10 bg-black/40 text-gray-300 hover:text-white hover:bg-white/5 hover:border-cyan-500/30"
            >
              <Eye className="h-3.5 w-3.5 mr-1" />
              Dettagli
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={handleDelete}
              disabled={isLoading}
              className="h-8 border-white/10 bg-black/40 text-red-400 hover:text-red-300 hover:bg-red-500/10 hover:border-red-500/30"
            >
              <Trash2 className="h-3.5 w-3.5" />
            </Button>
          </div>
        </div>
      </CardFooter>
    </Card>
  );
}
