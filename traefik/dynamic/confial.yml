http:
  routers:
    # Router principale per failms.org
    confial-failms:
      rule: "Host(`failms.org`) || Host(`www.failms.org`)"
      service: confial
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - security-headers@file
        - compress@file
        - confial-www-redirect

    # Router HTTP per redirect HTTPS
    confial-failms-http:
      rule: "Host(`failms.org`) || Host(`www.failms.org`)"
      service: confial
      entryPoints:
        - web
      middlewares:
        - https-redirect@file

    # Router legacy per fodivps1.cloud (redirect a failms.org)
    confial-legacy:
      rule: "Host(`confial.fodivps1.cloud`)"
      service: confial
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - security-headers@file
        - compress@file
        - confial-legacy-redirect

  middlewares:
    # Redirect www -> non-www
    confial-www-redirect:
      redirectRegex:
        regex: "^https://www\\.failms\\.org/(.*)"
        replacement: "https://failms.org/${1}"
        permanent: true

    # Redirect legacy domain
    confial-legacy-redirect:
      redirectRegex:
        regex: "^https://confial\\.fodivps1\\.cloud/(.*)"
        replacement: "https://failms.org/${1}"
        permanent: true

  services:
    confial:
      loadBalancer:
        servers:
          - url: "http://172.19.0.1:3020"
