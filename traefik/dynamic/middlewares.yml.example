# Traefik Dynamic Middleware Configuration
# 
# This file is VPS-specific and NOT tracked by git.
# Copy from middlewares.yml.example and customize for your VPS instance.
# Replace YOUR_DOMAIN with your actual panel domain.
#

http:
  middlewares:
    # Rate limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # Security headers
    security-headers:
      headers:
        frameDeny: false
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        # CSP - Content Security Policy
        # CUSTOMIZE: Replace YOUR_DOMAIN with your actual panel domain (e.g., fodivps1.cloud)
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://maps.googleapis.com https://www.googletagmanager.com https://challenges.cloudflare.com https://www.youtube.com https://player.vimeo.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://api.YOUR_DOMAIN https://storage.YOUR_DOMAIN https://remotion.YOUR_DOMAIN https://n8n.YOUR_DOMAIN wss://YOUR_DOMAIN wss://api.YOUR_DOMAIN https://maps.googleapis.com https://www.google-analytics.com https://analytics.google.com https://www.googletagmanager.com https://vimeo.com https://player.vimeo.com; frame-src 'self' https://maps.google.com https://www.google.com https://maps.googleapis.com https://*.google.com https://player.vimeo.com https://www.youtube.com https://challenges.cloudflare.com; media-src 'self' blob: https://storage.YOUR_DOMAIN; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;"
        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"
        # Permissions Policy
        permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"

    # CORS headers - SECURED (no wildcard)
    cors-headers:
      headers:
        # CUSTOMIZE: Add your panel domain and all project subdomains
        accessControlAllowOriginList:
          - "https://YOUR_DOMAIN"
          - "https://api.YOUR_DOMAIN"
          - "https://storage.YOUR_DOMAIN"
          - "https://n8n.YOUR_DOMAIN"
          # Add additional project origins as needed:
          # - "https://project1.YOUR_DOMAIN"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "PATCH"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Requested-With"
          - "Accept"
          - "Origin"
          - "X-CSRF-Token"
        accessControlAllowCredentials: true
        accessControlMaxAge: 86400
        addVaryHeader: true

    # Compression (Brotli preferred, fallback to gzip)
    compress:
      compress:
        minResponseBodyBytes: 1024
        includedContentTypes:
          - "text/html"
          - "text/plain"
          - "text/css"
          - "text/javascript"
          - "application/javascript"
          - "application/json"
          - "application/xml"
          - "image/svg+xml"
          - "application/font-woff"
          - "application/font-woff2"

    # Basic auth for Traefik dashboard
    auth-dashboard:
      basicAuth:
        users:
          # Password: Wmd+JSrj3lzdfyFhzW/+sQ== (changed 2025-11-29)
          # Generate with: htpasswd -nb admin password
          - "admin:$apr1$.8v3Hh59$Kl2h9zVllRzMH6d7LQ9A6."

    # Strip prefix (if needed)
    strip-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # Redirect scheme
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Basic auth for Monitoring stack
    auth-monitoring:
      basicAuth:
        users:
          # Password: FodiMonitor2025!Secure
          - "admin:$apr1$.8v3Hh59$Kl2h9zVllRzMH6d7LQ9A6."
