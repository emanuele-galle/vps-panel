# Traefik Dynamic Middleware Configuration

http:
  middlewares:
    # Rate limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # Security headers
    security-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        # CSP - Content Security Policy
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://api.fodivps1.cloud wss://fodivps1.cloud wss://api.fodivps1.cloud; frame-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;"
        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"
        # Permissions Policy
        permissionsPolicy: "camera=(), microphone=(), geolocation=(), payment=()"

    # CORS headers - SECURED (no wildcard)
    cors-headers:
      headers:
        accessControlAllowOriginList:
          - "https://fodivps1.cloud"
          - "https://api.fodivps1.cloud"
          - "https://tattoo.fodivps1.cloud"
          - "https://app.tattoo.fodivps1.cloud"
          - "https://media.tattoo.fodivps1.cloud"
          - "https://notaio.fodisrl.it"
          - "https://maison.fodivps1.cloud"
          - "https://app.maison.fodivps1.cloud"
          - "https://admin.maison.fodivps1.cloud"
          - "https://api.maison.fodivps1.cloud"
          - "https://eccellenze-italiane.fodivps1.cloud"
          - "https://fodi.fodivps1.cloud"
          - "https://storage.fodi.fodivps1.cloud"
          - "https://n8n.fodivps1.cloud"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "PATCH"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Requested-With"
          - "Accept"
          - "Origin"
        accessControlAllowCredentials: true
        accessControlMaxAge: 86400
        addVaryHeader: true

    # Compression (Brotli preferred, fallback to gzip)
    compress:
      compress:
        minResponseBodyBytes: 1024
        includedContentTypes:
          - "text/html"
          - "text/plain"
          - "text/css"
          - "text/javascript"
          - "application/javascript"
          - "application/json"
          - "application/xml"
          - "image/svg+xml"
          - "application/font-woff"
          - "application/font-woff2"

    # Basic auth for Traefik dashboard
    auth-dashboard:
      basicAuth:
        users:
          # Password: Wmd+JSrj3lzdfyFhzW/+sQ== (changed 2025-11-29)
          # Generate with: htpasswd -nb admin password
          - "admin:$apr1$.8v3Hh59$Kl2h9zVllRzMH6d7LQ9A6."

    # Strip prefix (if needed)
    strip-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # Redirect scheme
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Basic auth for Monitoring stack
    auth-monitoring:
      basicAuth:
        users:
          # Password: FodiMonitor2025!Secure
          - "admin:$apr1$.8v3Hh59$Kl2h9zVllRzMH6d7LQ9A6."
