networks:
  traefik-public:
    name: traefik-public
    external: true
  panel-internal:
    name: panel-internal
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  traefik-acme:
  traefik-logs:
  n8n-data:
  n8n-postgres-data:
  minio-data:
  remotion-data:

services:
  # ==================== TRAEFIK ====================
  traefik:
    image: traefik:3.6.7
    container_name: vps-panel-traefik
    restart: unless-stopped
    networks:
      - traefik-public
    ports:
      - "80:80"
      - "443:443"
      # Dashboard port removed for production security
      # - "8080:8080"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/certs:/etc/traefik/certs:ro
      - traefik-acme:/etc/traefik/acme
      - traefik-logs:/var/log/traefik
    environment:
      - CF_API_EMAIL=${CLOUDFLARE_EMAIL:-}
      - CF_API_KEY=${CLOUDFLARE_API_KEY:-}
      - DOCKER_API_VERSION=1.45
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.traefik.rule=Host(`traefik.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=auth-dashboard@file"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"

  # ==================== POSTGRESQL ====================
  postgres:
    image: postgres:18-alpine
    container_name: vps-panel-postgres
    restart: unless-stopped
    networks:
      - panel-internal
    ports:
      - "127.0.0.1:5445:5432"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          memory: 1G
    command: >
      postgres
      -c shared_buffers=512MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c work_mem=32MB
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c max_wal_size=1GB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c max_connections=150
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=2
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-vps_panel}
      POSTGRES_USER: ${POSTGRES_USER:-panel_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Please set POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-panel_user} -d ${POSTGRES_DB:-vps_panel}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== REDIS ====================
  redis:
    image: redis:8-alpine
    container_name: vps-panel-redis
    restart: unless-stopped
    networks:
      - panel-internal
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 200m --maxmemory-policy allkeys-lru --tcp-keepalive 300 --requirepass ${REDIS_PASSWORD:?Please set REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== BACKEND ====================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vps-panel-backend
    restart: unless-stopped
    group_add:
      - "988"  # docker group GID for socket access
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - panel-internal
      - traefik-public
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/www/projects:/var/www/projects
      - /var/www/uploads:/var/www/uploads
      - /var/backups/vps-panel:/var/backups/vps-panel
      - traefik-acme:/traefik-acme:ro
      # VPS Panel source for backup (read-only)
      - ./:/vps-panel-source:ro
      # Full VPS root access for admin Claude Code sessions
      - /root:/root
      - /var/www/workspaces:/var/www/workspaces
      # Node/NPM for MCP stdio servers
      - /usr/lib/node_modules:/usr/lib/node_modules:ro
      # Spline 3D assets library for PRO templates
      - /home/sviluppatore:/home/sviluppatore:ro
      - /home/sviluppatore/assets:/home/sviluppatore/assets
      # Claude Code config for maintenance cleanup
      # Development volumes removed for production
      # - ./backend/src:/app/src:cached
      # - ./backend/node_modules:/app/node_modules:cached
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3001
      HOST: 0.0.0.0
      HOME: /root
      PATH: /root/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      DATABASE_URL: postgresql://${POSTGRES_USER:-panel_user}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-vps_panel}?connection_limit=20&pool_timeout=30
      POSTGRES_USER: ${POSTGRES_USER:-panel_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-vps_panel}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET:?Please set JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?Please set ENCRYPTION_KEY}
      FRONTEND_URL: https://${PANEL_DOMAIN:-localhost}
      API_PUBLIC_URL: https://api.${PANEL_DOMAIN:-localhost}
      DOCKER_SOCKET: /var/run/docker.sock
      PROJECTS_ROOT: /var/www/projects
      TRAEFIK_NETWORK: traefik-public
      PREVIEW_DOMAIN: ${PREVIEW_DOMAIN:-preview.localhost}
      PANEL_DOMAIN: ${PANEL_DOMAIN:-localhost}
      COOKIE_DOMAIN: .${PANEL_DOMAIN:-localhost}
      FORCE_HTTPS: "true"
      HOSTINGER_API_KEY: ${HOSTINGER_API_KEY:-}
      HOSTINGER_API_URL: ${HOSTINGER_API_URL:-}
      ELEVENLABS_WEBHOOK_SECRET: ${ELEVENLABS_WEBHOOK_SECRET:-}
      ELEVENLABS_INTERNAL_SECRET: ${ELEVENLABS_INTERNAL_SECRET:-}
      FILEBROWSER_SYSTEM_USERNAME: ${FILEBROWSER_SYSTEM_USERNAME:-admin}
      FILEBROWSER_SYSTEM_PASSWORD: ${FILEBROWSER_SYSTEM_PASSWORD:?Please set FILEBROWSER_SYSTEM_PASSWORD}
      GDRIVE_BACKUP_FOLDER: ${GDRIVE_BACKUP_FOLDER:-}
      N8N_WEBHOOK_BASE_URL: https://n8n.${PANEL_DOMAIN:-localhost}/webhook
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`api.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend.middlewares=security-headers@file,compress@file"
      - "traefik.http.services.backend.loadbalancer.server.port=3001"
      # WebSocket router for Socket.IO
      - "traefik.http.routers.backend-ws.rule=Host(`api.${PANEL_DOMAIN:-localhost}`) && PathPrefix(`/socket.io`)"
      - "traefik.http.routers.backend-ws.entrypoints=websecure"
      - "traefik.http.routers.backend-ws.tls.certresolver=letsencrypt"
      - "traefik.http.routers.backend-ws.middlewares=security-headers@file"
      - "traefik.http.routers.backend-ws.service=backend"

  # ==================== FRONTEND ====================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://api.${PANEL_DOMAIN:-localhost}/api
        NEXT_PUBLIC_WS_URL: wss://api.${PANEL_DOMAIN:-localhost}
        NEXT_PUBLIC_FILEBROWSER_USERNAME: ${FILEBROWSER_SYSTEM_USERNAME:-admin}
        NEXT_PUBLIC_FILEBROWSER_PASSWORD: ${FILEBROWSER_SYSTEM_PASSWORD:-}
        NEXT_PUBLIC_PANEL_DOMAIN: ${PANEL_DOMAIN:-localhost}
        NEXT_PUBLIC_SMTP_USER: ${SMTP_DISPLAY_USER:-}
        NEXT_PUBLIC_SMTP_PASSWORD: ${SMTP_DISPLAY_PASSWORD:-}
    container_name: vps-panel-frontend
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - traefik-public
    # volumes removed for production - source mounting breaks compiled API URLs
    environment:
      NEXT_PUBLIC_API_URL: https://api.${PANEL_DOMAIN:-localhost}/api
      NEXT_PUBLIC_WS_URL: wss://api.${PANEL_DOMAIN:-localhost}
      NEXT_PUBLIC_FILEBROWSER_USERNAME: ${FILEBROWSER_SYSTEM_USERNAME:-admin}
      NEXT_PUBLIC_FILEBROWSER_PASSWORD: ${FILEBROWSER_SYSTEM_PASSWORD:-}
      NEXT_PUBLIC_PANEL_DOMAIN: ${PANEL_DOMAIN:-localhost}
      NEXT_PUBLIC_SMTP_USER: ${SMTP_DISPLAY_USER:-}
      NEXT_PUBLIC_SMTP_PASSWORD: ${SMTP_DISPLAY_PASSWORD:-}
    depends_on:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.frontend.middlewares=security-headers@file,compress@file"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

  # ==================== ADMINER ====================
  adminer:
    image: adminer:latest
    container_name: vps-panel-adminer
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
    networks:
      - panel-internal
      - traefik-public
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adminer.rule=Host(`db.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.adminer.entrypoints=websecure"
      - "traefik.http.routers.adminer.tls.certresolver=letsencrypt"
      # IP whitelist: only VPS local + common admin IPs (add your IP here)
      - "traefik.http.middlewares.adminer-ipwhitelist.ipallowlist.sourcerange=127.0.0.1/32,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
      - "traefik.http.routers.adminer.middlewares=adminer-ipwhitelist,security-headers@file,auth-dashboard@file"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

  # ==================== N8N POSTGRESQL ====================
  n8n-postgres:
    image: postgres:18-alpine
    container_name: vps-panel-n8n-postgres
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    networks:
      - panel-internal
    volumes:
      - n8n-postgres-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${N8N_POSTGRES_DB:-n8n}
      POSTGRES_USER: ${N8N_POSTGRES_USER:-n8n}
      POSTGRES_PASSWORD: ${N8N_POSTGRES_PASSWORD:?Please set N8N_POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_POSTGRES_USER:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== N8N AUTOMATION ====================
  n8n:
    image: n8nio/n8n:2.7.1
    container_name: vps-panel-n8n
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
    networks:
      - panel-internal
      - traefik-public
    volumes:
      - n8n-data:/home/node/.n8n
      - /var/www/projects:/projects:ro
      - /var/backups/vps-panel/n8n:/backups
    environment:
      # N8N Core Settings
      N8N_HOST: ${N8N_HOST:-n8n.localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      WEBHOOK_URL: ${N8N_WEBHOOK_URL:-https://n8n.localhost/}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:?Please set N8N_ENCRYPTION_KEY}
      # Database
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: n8n-postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${N8N_POSTGRES_DB:-n8n}
      DB_POSTGRESDB_USER: ${N8N_POSTGRES_USER:-n8n}
      DB_POSTGRESDB_PASSWORD: ${N8N_POSTGRES_PASSWORD}
      # Security
      N8N_USER_MANAGEMENT_JWT_SECRET: ${JWT_SECRET}
      N8N_BASIC_AUTH_ACTIVE: "false"
      # Features
      N8N_METRICS: "true"
      N8N_PUBLIC_API_ENABLED: "true"
      N8N_LOG_LEVEL: info
      N8N_LOG_OUTPUT: console
      EXECUTIONS_DATA_PRUNE: "true"
      # Proxy Settings (for Traefik)
      N8N_PROXY_HOPS: 1
      EXECUTIONS_DATA_MAX_AGE: 168
      # Timezone
      GENERIC_TIMEZONE: Europe/Rome
      TZ: Europe/Rome
      # Code node modules - restricted to necessary builtins only
      NODE_FUNCTION_ALLOW_BUILTIN: "crypto,url,querystring,path,util,buffer,stream,http,https,zlib,os"
      NODE_FUNCTION_ALLOW_EXTERNAL: "axios,lodash,moment,date-fns,xml2js,cheerio,jsonwebtoken,uuid"
    depends_on:
      n8n-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n.middlewares=security-headers@file"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "app=n8n"
      - "type=automation"

  # ==================== REMOTION STUDIO ====================
  remotion-studio:
    build:
      context: ./remotion
      dockerfile: Dockerfile
    container_name: remotion-studio
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - traefik-public
    volumes:
      - remotion-data:/app/out
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.remotion.rule=Host(`remotion.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.remotion.entrypoints=websecure"
      - "traefik.http.routers.remotion.tls.certresolver=letsencrypt"
      - "traefik.http.routers.remotion.middlewares=security-headers@file,auth-dashboard@file"
      - "traefik.http.services.remotion.loadbalancer.server.port=3000"
      - "app=remotion"
      - "type=tools"

  # ==================== MINIO (Shared Storage) ====================
  minio:
    image: minio/minio:latest
    container_name: vps-panel-minio
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - panel-internal
      - traefik-public
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-vps_minio_admin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?Please set MINIO_ROOT_PASSWORD}
      MINIO_BROWSER_REDIRECT_URL: https://storage.${PANEL_DOMAIN:-localhost}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
    labels:
      - "traefik.enable=true"
      # MinIO API
      - "traefik.http.routers.minio-api.rule=Host(`s3.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-api.service=minio-api"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      # MinIO Console
      - "traefik.http.routers.minio-console.rule=Host(`storage.${PANEL_DOMAIN:-localhost}`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=letsencrypt"
      - "traefik.http.routers.minio-console.service=minio-console"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"
      - "app=minio"
      - "type=storage"
