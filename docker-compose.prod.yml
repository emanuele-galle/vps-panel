version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: vps-panel-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-vps_panel}
      POSTGRES_USER: ${DATABASE_USER:-vpsadmin}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups/postgres:/backups
    networks:
      - vps-panel-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-vpsadmin} -d ${DATABASE_NAME:-vps_panel}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
      args:
        NODE_ENV: production
    container_name: vps-panel-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${DATABASE_USER:-vpsadmin}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME:-vps_panel}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      FRONTEND_URL: https://${DOMAIN}
      PORT: 3001
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      HOSTINGER_API_KEY: ${HOSTINGER_API_KEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./backend/uploads:/app/uploads
      - ./backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - vps-panel-network
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vps-panel-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.vps-panel-api.entrypoints=websecure"
      - "traefik.http.routers.vps-panel-api.tls=true"
      - "traefik.http.routers.vps-panel-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.vps-panel-api.loadbalancer.server.port=3001"
      - "traefik.docker.network=traefik-network"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        NEXT_PUBLIC_API_URL: https://${DOMAIN}
        NODE_ENV: production
    container_name: vps-panel-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://${DOMAIN}
    depends_on:
      - backend
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vps-panel-frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.vps-panel-frontend.entrypoints=websecure"
      - "traefik.http.routers.vps-panel-frontend.tls=true"
      - "traefik.http.routers.vps-panel-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.vps-panel-frontend.loadbalancer.server.port=3000"
      - "traefik.docker.network=traefik-network"
      # Security headers
      - "traefik.http.middlewares.security-headers.headers.framedeny=true"
      - "traefik.http.middlewares.security-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Frame-Options=DENY"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Content-Type-Options=nosniff"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-XSS-Protection=1; mode=block"
      - "traefik.http.routers.vps-panel-frontend.middlewares=security-headers@docker"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.0
    container_name: vps-panel-traefik
    restart: unless-stopped
    command:
      # API and Dashboard
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=traefik-network"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=true"
      - "--accesslog.filepath=/logs/access.log"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
      - traefik_logs:/logs
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-auth"
      # Basic auth for dashboard (user: admin, password: set in TRAEFIK_DASHBOARD_AUTH)
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Adminer - Database Management (Optional)
  adminer:
    image: adminer:latest
    container_name: vps-panel-adminer
    restart: unless-stopped
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    depends_on:
      - postgres
    networks:
      - vps-panel-network
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vps-panel-adminer.rule=Host(`adminer.${DOMAIN}`)"
      - "traefik.http.routers.vps-panel-adminer.entrypoints=websecure"
      - "traefik.http.routers.vps-panel-adminer.tls=true"
      - "traefik.http.routers.vps-panel-adminer.tls.certresolver=letsencrypt"
      - "traefik.http.services.vps-panel-adminer.loadbalancer.server.port=8080"
      - "traefik.docker.network=traefik-network"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

volumes:
  postgres_data:
    name: vps-panel-postgres-data
  traefik_letsencrypt:
    name: vps-panel-letsencrypt
  traefik_logs:
    name: vps-panel-traefik-logs

networks:
  vps-panel-network:
    name: vps-panel-network
    driver: bridge
  traefik-network:
    name: traefik-network
    driver: bridge
    external: true
